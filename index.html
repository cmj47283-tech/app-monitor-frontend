<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>App Monitor</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  padding: 20px;
  background: #f5f6fa;
  color: #333;
}
.container { max-width: 1400px; margin: 0 auto; }
h1 { margin-bottom: 16px; }

input {
  padding: 6px 10px;
  margin: 4px;
  border-radius: 4px;
  border: 1px solid #ccc;
}
button {
  padding: 6px 12px;
  margin: 4px;
  cursor: pointer;
  border-radius: 4px;
  border: none;
  background: #4CAF50;
  color: #fff;
  transition: 0.2s;
}
button:hover { background: #45a049; }

.table-wrapper {
  overflow-x: auto;
  background: #fff;
  padding: 10px;
  border-radius: 10px;
  box-shadow: 0 0 8px rgba(0,0,0,0.1);
  margin-top: 16px;
}

table {
  width: 100%;
  border-collapse: collapse;
  table-layout: auto;
}
th, td {
  border: 1px solid #ccc;
  padding: 8px;
  text-align: left;
  vertical-align: top;
  white-space: normal;
  word-break: break-word;
}

table td { font-size: 0.85rem; }

th {
  background: #f0f0f0;
  font-weight: bold;
  position: relative;
  cursor: col-resize;
}

.status-active { color: #0a7f3b; font-weight: 600; }
.status-removed { color: #c23b3b; font-weight: 600; }
.status-unknown { color: #777; }

.button-delete { background: #d9534f; }
.button-delete:hover { background: #c9302c; }

.small { color: #666; font-size: 0.9rem; }

th.resizable { position: relative; }
th.resizable .resizer {
  width: 6px;
  height: 100%;
  position: absolute;
  right: 0;
  top: 0;
  cursor: col-resize;
  user-select: none;
}

td.dev-col, td.note-col { font-size: 0.75rem; word-break: break-word; }
.nowrap { white-space: nowrap !important; }
</style>
</head>
<body>
<div class="container">
<h1>App Monitor</h1>

<div id="add-app-form">
<input id="pkgInput" placeholder="Package name e.g. com.example.app">
<input id="noteInput" placeholder="Note (optional)">
<button id="addBtn">Add App</button>
<span id="add-msg" class="small"></span>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th class="resizable" data-col="package_name">Package<div class="resizer"></div></th>
<th class="resizable" data-col="app_name">App Name<div class="resizer"></div></th>
<th class="resizable" data-col="created_at">Created At<div class="resizer"></div></th>
<th class="resizable" data-col="first_seen">First Seen<div class="resizer"></div></th>
<th class="resizable" data-col="removed_at">Removed At<div class="resizer"></div></th>
<th class="resizable" data-col="app_status">App Status<div class="resizer"></div></th>
<th class="resizable" data-col="dev_id">Dev ID<div class="resizer"></div></th>
<th class="resizable" data-col="dev_status">Dev Status<div class="resizer"></div></th>
<th class="resizable" data-col="dev_banned_at">Dev Banned Time<div class="resizer"></div></th>
<th class="resizable" data-col="last_checked">Last Checked<div class="resizer"></div></th>
<th class="resizable" data-col="note">Note<div class="resizer"></div></th>
<th class="resizable" data-col="actions">Actions<div class="resizer"></div></th>
</tr>
</thead>
<tbody id="appsBody"></tbody>
</table>
</div>
</div>

<script>
const SUPABASE_URL = "https://sbmejkwmkpdaokvqkwnv.supabase.co";
const SUPABASE_PUBLIC_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNibWVqa3dta3BkYW9rdnFrd252Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1OTU1OTAsImV4cCI6MjA4MDE3MTU5MH0.sWKZ7ePFp7_exkYioRHOkG8KYFtCouJr7ba-tV4iKy0";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY);

function fmt(ts){ if(!ts) return ""; try{ return new Date(ts).toLocaleString(); }catch(e){ return String(ts); } }
function escapeHtml(str){ if(typeof str!=="string") return str; return str.replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

async function renderApps(){
  const { data, error } = await supabaseClient.from("apps").select("*").order("created_at",{ascending:false});
  const tbody = document.getElementById("appsBody");
  tbody.innerHTML = "";
  if(error){
    tbody.innerHTML = `<tr><td colspan="14" style="color:red">${error.message}</td></tr>`;
    return;
  }

  data.forEach(row=>{
    const tr = document.createElement("tr");

    let appStatusClass = "status-unknown";
    if(row.app_status==="active"||row.app_status==="live") appStatusClass="status-active";
    if(row.app_status==="removed"||row.app_status==="down") appStatusClass="status-removed";

    let devStatusClass="status-unknown";
    if(row.dev_status==="active") devStatusClass="status-active";
    if(row.dev_status==="removed") devStatusClass="status-removed";

    const noteInput=document.createElement("input");
    noteInput.value=row.note||"";
    noteInput.style.width="100%";
    noteInput.addEventListener("change", async ()=>{
      const { error } = await supabaseClient.from("apps").update({note:noteInput.value}).eq("id", row.id);
      if(error) alert("Update note error: "+error.message);
    });

    tr.innerHTML=`
      <td>${escapeHtml(row.package_name)}</td>
      <td>${escapeHtml(row.app_name||"")}</td>
      <td>${fmt(row.created_at)}</td>
      <td>${fmt(row.first_seen)}</td>
      <td>${fmt(row.removed_at)}</td>
      <td class="${appStatusClass} nowrap">${escapeHtml(row.app_status||"unknown")}</td>
      <td class="dev-col">${escapeHtml(row.dev_id||"")}</td>
      <td class="${devStatusClass} nowrap">${escapeHtml(row.dev_status||"unknown")}</td>
      <td>${fmt(row.dev_banned_at)}</td>
      <td>${fmt(row.last_checked)}</td>
      <td class="note-col"></td>
      <td class="nowrap"></td>
    `;

    tr.querySelector("td:nth-child(13)").appendChild(noteInput);

    const delBtn=document.createElement("button");
    delBtn.textContent="Delete";
    delBtn.className="button-delete nowrap";
    delBtn.onclick=async ()=>{
      if(!confirm("Delete this app?")) return;
      const { error }=await supabaseClient.from("apps").delete().eq("id", row.id);
      if(error) alert("Delete error: "+error.message);
      else renderApps();
    };
    tr.querySelector("td:nth-child(14)").appendChild(delBtn);

    tbody.appendChild(tr);
  });
}

document.getElementById("addBtn").onclick=async ()=>{
  const pkg=document.getElementById("pkgInput").value.trim();
  const note=document.getElementById("noteInput").value.trim();
  const msgEl=document.getElementById("add-msg");
  if(!pkg){ alert("Please enter package name"); return; }

  const { error } = await supabaseClient.from("apps").insert({
    package_name: pkg,
    note: note||null,
    app_status:"unknown",
    created_at:new Date().toISOString()
  });

  if(error){ alert("Add app error: "+error.message); return; }

  document.getElementById("pkgInput").value="";
  document.getElementById("noteInput").value="";
  msgEl.textContent="Added.";
  setTimeout(()=>msgEl.textContent="",2000);
  renderApps();
};

renderApps();

// -------------------- 可拖动列宽 + 记忆列宽 --------------------
const tableKey="app-monitor-col-widths";
function loadColumnWidths(){
  const saved=localStorage.getItem(tableKey);
  if(!saved) return;
  const widths=JSON.parse(saved);
  document.querySelectorAll("th.resizable").forEach(th=>{
    const key=th.dataset.col;
    if(key && widths[key]) th.style.width=widths[key];
  });
}
function saveColumnWidths(){
  const widths={};
  document.querySelectorAll("th.resizable").forEach(th=>{
    const key=th.dataset.col;
    if(key) widths[key]=th.style.width;
  });
  localStorage.setItem(tableKey, JSON.stringify(widths));
}
document.querySelectorAll("th.resizable").forEach(th=>{
  const resizer=th.querySelector(".resizer");
  const key=th.dataset.col;
  if(!resizer||!key) return;
  let startX,startWidth;
  resizer.addEventListener("mousedown",(e)=>{
    startX=e.pageX;
    startWidth=th.offsetWidth;
    document.documentElement.style.cursor="col-resize";
    const onMouseMove=(e)=>{
      const newWidth=startWidth+(e.pageX-startX);
      th.style.width=newWidth+"px";
    };
    const onMouseUp=()=>{
      document.removeEventListener("mousemove",onMouseMove);
      document.removeEventListener("mouseup",onMouseUp);
      document.documentElement.style.cursor="";
      saveColumnWidths();
    };
    document.addEventListener("mousemove",onMouseMove);
    document.addEventListener("mouseup",onMouseUp);
  });
});
loadColumnWidths();
</script>
</body>
</html>
