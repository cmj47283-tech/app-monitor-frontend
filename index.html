<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>App Monitor - Supabase Frontend</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 20px; }
.container { max-width: 1000px; margin: 0 auto; }
input { padding: 6px; margin: 4px; }
button { padding: 6px 12px; margin: 4px; cursor: pointer; }
table { width: 100%; border-collapse: collapse; margin-top: 12px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #f7f7f7; }
.status-active { color: #0a7f3b; font-weight: 700; }
.status-removed { color: #c23b3b; font-weight: 700; }
.status-unknown { color: #777; }
.row-note { width: 200px; }
</style>
</head>
<body>
<div class="container">
  <h1>App Monitor</h1>

  <div id="add-app-form">
    <input id="pkgInput" placeholder="Package name e.g. com.example.app">
    <input id="noteInput" placeholder="Note (optional)">
    <button id="addBtn">Add App</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Package</th>
        <th>Created At</th>
        <th>First Seen</th>
        <th>Removed At</th>
        <th>Dev Banned</th>
        <th>Status</th>
        <th class="row-note">Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="appsBody"></tbody>
  </table>
</div>

<script>
// ---------- Supabase 初始化 ----------
const SUPABASE_URL = "https://sbmejkwmkpdaokvqkwnv.supabase.co";
const SUPABASE_PUBLIC_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNibWVqa3dta3BkYW9rdnFrd252Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1OTU1OTAsImV4cCI6MjA4MDE3MTU5MH0.sWKZ7ePFp7_exkYioRHOkG8KYFtCouJr7ba-tV4iKy0";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY);

// ---------- 格式化日期 ----------
function fmt(ts) {
  if (!ts) return '';
  try { return new Date(ts).toLocaleString(); }
  catch(e) { return ts; }
}

// ---------- 渲染 apps 表 ----------
async function renderApps() {
  const { data, error } = await supabase
    .from('apps')
    .select('*')
    .order('created_at', { ascending: false });

  if (error) {
    console.error("Fetch apps error:", error);
    return;
  }

  const tbody = document.getElementById('appsBody');
  tbody.innerHTML = '';

  data.forEach(row => {
    const tr = document.createElement('tr');

    let statusClass = 'status-unknown';
    const status = row.status || 'unknown';
    if (status === 'active' || status === 'live') statusClass = 'status-active';
    if (status === 'removed' || status === 'down') statusClass = 'status-removed';

    const noteInput = document.createElement('input');
    noteInput.value = row.note || '';
    noteInput.style.width = '100%';
    noteInput.onchange = async () => {
      await supabase.from('apps').update({ note: noteInput.value }).eq('id', row.id);
      renderApps(); // 更新显示
    };

    tr.innerHTML = `
      <td>${row.package_name}</td>
      <td>${fmt(row.created_at)}</td>
      <td>${fmt(row.first_seen)}</td>
      <td>${fmt(row.removed_at)}</td>
      <td>${fmt(row.dev_banned_at)}</td>
      <td class="${statusClass}">${status}</td>
      <td></td>
      <td></td>
    `;
    tr.querySelector('td:nth-child(7)').appendChild(noteInput);

    const delBtn = document.createElement('button');
    delBtn.textContent = 'Delete';
    delBtn.onclick = async () => {
      if (!confirm("Delete this app?")) return;
      await supabase.from('apps').delete().eq('id', row.id);
      renderApps();
    };
    tr.querySelector('td:nth-child(8)').appendChild(delBtn);

    tbody.appendChild(tr);
  });
}

// ---------- 添加 app ----------
document.getElementById('addBtn').addEventListener('click', async () => {
  const pkg = document.getElementById('pkgInput').value.trim();
  const note = document.getElementById('noteInput').value.trim();
  if (!pkg) { alert("Please enter package name"); return; }

  const { error } = await supabase.from('apps').insert({
    package_name: pkg,
    note: note,
    status: 'unknown'
  });

  if (error) {
    alert("Add app error: " + error.message);
    console.error(error);
    return;
  }

  document.getElementById('pkgInput').value = '';
  document.getElementById('noteInput').value = '';
  renderApps();
});

// ---------- 页面初始加载 ----------
renderApps();

</script>
</body>
</html>
