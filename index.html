<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>App Monitor</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { 
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; 
  padding: 20px; 
  background: #f5f6fa; 
  color: #333; 
  margin: 0; 
}

.container { 
  max-width: 1400px; 
  margin: 0 auto; 
}

h1 { margin-bottom: 16px; }

input { 
  padding: 6px 10px; 
  margin: 4px; 
  border-radius: 4px; 
  border: 1px solid #ccc; 
}

button { 
  padding: 6px 12px; 
  margin: 4px; 
  cursor: pointer; 
  border-radius: 4px; 
  border: none; 
  background: #4CAF50; 
  color: #fff; 
  transition: 0.2s; 
}

button:hover { background: #45a049; }

.table-wrapper { 
  overflow-x: auto; 
  background: #fff; 
  padding: 10px; 
  border-radius: 6px; 
  box-shadow: 0 0 10px rgba(0,0,0,0.1); 
  margin-top: 16px; 
}

table { 
  width: 100%; 
  border-collapse: collapse; 
  table-layout: auto; 
  min-width: 1000px; /* 保证小屏也能横向滚动 */
}

th, td { 
  border: 1px solid #ccc; 
  padding: 8px; 
  text-align: left; 
  vertical-align: top; 
}

th { 
  background: #f0f0f0; 
  font-weight: bold; 
}

.status-active { color: #0a7f3b; font-weight: 600; }
.status-removed { color: #c23b3b; font-weight: 600; }
.status-unknown { color: #777; }

.row-note { 
  white-space: pre-wrap; 
  word-wrap: break-word; 
  max-width: 300px; 
}

.button-delete { 
  background: #d9534f; 
}

.button-delete:hover { 
  background: #c9302c; 
}

.small { color: #666; font-size: 0.9rem; }

input.note-input { 
  width: 100%; 
  box-sizing: border-box; 
}
</style>
</head>
<body>
<div class="container">
<h1>App Monitor</h1>

<div id="add-app-form">
<input id="pkgInput" placeholder="Package name e.g. com.example.app">
<input id="noteInput" placeholder="Note (optional)">
<button id="addBtn">Add App</button>
<span id="add-msg" class="small"></span>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Package</th>
<th>Created At</th>
<th>First Seen</th>
<th>Last Checked</th>
<th>Removed At</th>
<th>Dev ID</th>
<th>Dev Banned</th>
<th>Status</th>
<th>Note</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="appsBody"></tbody>
</table>
</div>
</div>

<script>
// 保留你原来的 Supabase 配置和逻辑
const SUPABASE_URL = "https://sbmejkwmkpdaokvqkwnv.supabase.co";
const SUPABASE_PUBLIC_KEY = "你的公钥";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY);

function fmt(ts){ if(!ts) return ''; try{ return new Date(ts).toLocaleString(); }catch(e){ return String(ts); } }
function escapeHtml(str){ if(typeof str!=='string') return str; return str.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

async function renderApps(){
  const { data, error } = await supabaseClient.from('apps').select('*').order('created_at',{ascending:false});
  const tbody = document.getElementById('appsBody');
  tbody.innerHTML='';
  if(error){ tbody.innerHTML=`<tr><td colspan="10" style="color:red">${error.message}</td></tr>`; return; }

  data.forEach(row=>{
    const tr = document.createElement('tr');

    let statusClass='status-unknown';
    if(row.status==='active'||row.status==='live') statusClass='status-active';
    if(row.status==='removed'||row.status==='down') statusClass='status-removed';

    // Note 可编辑
    const noteInput=document.createElement('input');
    noteInput.className='note-input';
    noteInput.value=row.note||'';
    noteInput.addEventListener('change', async ()=>{
      const { error } = await supabaseClient.from('apps').update({note:noteInput.value}).eq('id', row.id);
      if(error) alert('Update note error: '+error.message);
    });

    tr.innerHTML=`
      <td>${escapeHtml(row.package_name)}</td>
      <td>${fmt(row.created_at)}</td>
      <td>${fmt(row.first_seen)}</td>
      <td>${fmt(row.last_checked)}</td>
      <td>${fmt(row.removed_at)}</td>
      <td>${escapeHtml(row.dev_id||'')}</td>
      <td>${fmt(row.dev_banned_at)}</td>
      <td class="${statusClass}">${escapeHtml(row.status||'unknown')}</td>
      <td></td>
      <td></td>
    `;
    tr.querySelector('td:nth-child(9)').appendChild(noteInput);

    const delBtn=document.createElement('button');
    delBtn.textContent='Delete';
    delBtn.className='button-delete';
    delBtn.addEventListener('click', async ()=>{
      if(!confirm('Delete this app?')) return;
      const { error }=await supabaseClient.from('apps').delete().eq('id', row.id);
      if(error) alert('Delete error: '+error.message); else renderApps();
    });
    tr.querySelector('td:nth-child(10)').appendChild(delBtn);

    tbody.appendChild(tr);
  });
}

document.getElementById('addBtn').addEventListener('click', async ()=>{
  const pkg=document.getElementById('pkgInput').value.trim();
  const note=document.getElementById('noteInput').value.trim();
  const msgEl=document.getElementById('add-msg');
  msgEl.textContent='';
  if(!pkg){ alert('Please enter package name'); return; }

  const { data, error } = await supabaseClient.from('apps').insert({
    package_name: pkg,
    note: note||null,
    status:'unknown',
    created_at:new Date().toISOString()
  }).select().single();

  if(error){ alert('Add app error: '+error.message); console.error(error); return; }

  document.getElementById('pkgInput').value='';
  document.getElementById('noteInput').value='';
  msgEl.textContent='Added.';
  setTimeout(()=>msgEl.textContent='',2000);
  renderApps();
});

renderApps();
</script>
</body>
</html>
