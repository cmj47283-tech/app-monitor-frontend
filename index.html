<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>App Monitor - Core</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input { padding: 6px; margin: 4px; }
    button { padding: 6px 10px; margin: 4px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f0f0f0; }
    .status-active { color: green; font-weight: bold; }
    .status-removed { color: red; font-weight: bold; }
    .status-unknown { color: gray; }
  </style>
</head>
<body>

<h1>App Monitor - Core</h1>

<div id="add-form">
  <input id="pkgInput" placeholder="Package name e.g. com.example.app" />
  <input id="noteInput" placeholder="Note (optional)" />
  <button id="addBtn">Add App</button>
</div>

<table>
  <thead>
    <tr>
      <th>Package</th>
      <th>First Seen</th>
      <th>Removed At</th>
      <th>Dev Banned</th>
      <th>Status</th>
      <th>Note</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="appsBody"></tbody>
</table>

<script>
  // 配置 Supabase
  const SUPABASE_URL = "https://sbmejkwmkpdaokvqkwnv.supabase.co";
  const SUPABASE_PUBLIC_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNibWVqa3dta3BkYW9rdnFrd252Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1OTU1OTAsImV4cCI6MjA4MDE3MTU5MH0.sWKZ7ePFp7_exkYioRHOkG8KYFtCouJr7ba-tV4iKy0";

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY);

  function fmt(ts) {
    if (!ts) return '';
    try { return new Date(ts).toLocaleString(); } catch(e) { return ts; }
  }

  async function renderApps() {
    const { data, error } = await supabase.from('apps').select('*').order('created_at', { ascending: false });
    if (error) { console.error('Error fetching apps:', error); return; }

    const tbody = document.getElementById('appsBody');
    tbody.innerHTML = '';

    data.forEach(row => {
      const tr = document.createElement('tr');

      let statusClass = 'status-unknown';
      if (row.status === 'active' || row.status === 'live') statusClass = 'status-active';
      if (row.status === 'removed' || row.status === 'down') statusClass = 'status-removed';

      const noteInput = document.createElement('input');
      noteInput.value = row.note || '';
      noteInput.style.width = '100%';
      noteInput.onchange = async () => {
        await supabase.from('apps').update({ note: noteInput.value }).eq('id', row.id);
      };

      tr.innerHTML = `
        <td>${row.package_name}</td>
        <td>${fmt(row.first_seen)}</td>
        <td>${fmt(row.removed_at)}</td>
        <td>${fmt(row.dev_banned_at)}</td>
        <td class="${statusClass}">${row.status || 'unknown'}</td>
        <td></td>
        <td></td>
      `;

      tr.querySelector('td:nth-child(6)').appendChild(noteInput);

      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.onclick = async () => {
        if (!confirm('Delete this app?')) return;
        await supabase.from('apps').delete().eq('id', row.id);
        renderApps();
      };
      tr.querySelector('td:nth-child(7)').appendChild(delBtn);

      tbody.appendChild(tr);
    });
  }

  document.getElementById('addBtn').addEventListener('click', async () => {
    const pkg = document.getElementById('pkgInput').value.trim();
    const note = document.getElementById('noteInput').value.trim();
    if (!pkg) { alert('Please enter a package name'); return; }

    await supabase.from('apps').insert({ package_name: pkg, note: note, status: 'unknown' });
    document.getElementById('pkgInput').value = '';
    document.getElementById('noteInput').value = '';
    renderApps();
  });

  // 页面加载时渲染表格
  renderApps();
</script>

</body>
</html>
