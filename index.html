<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>App Monitor</title>

<!-- Supabase v2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 20px; }
.container { max-width: 1000px; margin: 0 auto; }
input { padding: 6px; margin: 4px; }
button { padding: 6px 12px; margin: 4px; cursor: pointer; }
table { width: 100%; border-collapse: collapse; margin-top: 12px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #f7f7f7; }
.status-active { color: #0a7f3b; font-weight: 700; }
.status-removed { color: #c23b3b; font-weight: 700; }
.status-unknown { color: #777; }
.row-note { width: 200px; }
.small { color: #666; font-size: 0.9rem; }
</style>
</head>
<body>
<div class="container">
  <h1>App Monitor</h1>

  <div id="add-app-form">
    <input id="pkgInput" placeholder="Package name e.g. com.example.app">
    <input id="noteInput" placeholder="Note (optional)">
    <button id="addBtn">Add App</button>
    <span id="add-msg" class="small"></span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Package</th>
        <th>Created At</th>
        <th>First Seen</th>
        <th>Last Checked</th>
        <th>Removed At</th>
        <th>Dev ID</th>
        <th>Dev Banned</th>
        <th>Status</th>
        <th class="row-note">Note</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="appsBody"></tbody>
  </table>
</div>

<script>
/* --- 配置 Supabase --- */
const SUPABASE_URL = "https://sbmejkwmkpdaokvqkwnv.supabase.co";
const SUPABASE_PUBLIC_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNibWVqa3dta3BkYW9rdnFrd252Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1OTU1OTAsImV4cCI6MjA4MDE3MTU5MH0.sWKZ7ePFp7_exkYioRHOkG8KYFtCouJr7ba-tV4iKy0";

// 确认库加载
if (typeof supabase === 'undefined') {
  document.body.innerHTML = '<div style="padding:20px;color:crimson">Error: Supabase JS library not loaded.</div>';
  throw new Error('Supabase JS library not loaded.');
}

// 创建客户端
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY);

// 日期格式化
function fmt(ts) {
  if (!ts) return '';
  try { return new Date(ts).toLocaleString(); }
  catch(e) { return String(ts); }
}

// 转义 HTML
function escapeHtml(str) {
  if (typeof str !== 'string') return str;
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// 渲染 apps 列表
async function renderApps() {
  const { data, error } = await supabaseClient
    .from('apps')
    .select('*')
    .order('created_at', { ascending: false });

  const tbody = document.getElementById('appsBody');
  tbody.innerHTML = '';

  if (error) {
    console.error('Fetch apps error:', error);
    tbody.innerHTML = `<tr><td colspan="10" style="color:crimson">Error fetching apps: ${error.message}</td></tr>`;
    return;
  }

  data.forEach(row => {
    const tr = document.createElement('tr');

    const status = row.status || 'unknown';
    let statusClass = 'status-unknown';
    if (status === 'active' || status === 'live') statusClass = 'status-active';
    if (status === 'removed' || status === 'down') statusClass = 'status-removed';

    // note 可编辑
    const noteInput = document.createElement('input');
    noteInput.value = row.note || '';
    noteInput.style.width = '100%';
    noteInput.addEventListener('change', async () => {
      const { error } = await supabaseClient.from('apps').update({ note: noteInput.value }).eq('id', row.id);
      if (error) alert('Update note error: ' + error.message);
    });

    tr.innerHTML = `
      <td>${escapeHtml(row.package_name)}</td>
      <td>${fmt(row.created_at)}</td>
      <td>${fmt(row.first_seen)}</td>
      <td>${fmt(row.last_checked)}</td>
      <td>${fmt(row.removed_at)}</td>
      <td>${escapeHtml(row.dev_id || '')}</td>
      <td>${row.dev_banned_at ? fmt(row.dev_banned_at) + ' (Banned)' : 'Active'}</td>
      <td class="${statusClass}">${escapeHtml(status)}</td>
      <td></td>
      <td></td>
    `;
    tr.querySelector('td:nth-child(9)').appendChild(noteInput);

    const delBtn = document.createElement('button');
    delBtn.textContent = 'Delete';
    delBtn.addEventListener('click', async () => {
      if (!confirm('Delete this app?')) return;
      const { error } = await supabaseClient.from('apps').delete().eq('id', row.id);
      if (error) alert('Delete error: ' + error.message);
      else renderApps();
    });
    tr.querySelector('td:nth-child(10)').appendChild(delBtn);

    tbody.appendChild(tr);
  });
}

// 添加 app
document.getElementById('addBtn').addEventListener('click', async () => {
  const pkg = document.getElementById('pkgInput').value.trim();
  const note = document.getElementById('noteInput').value.trim();
  const msgEl = document.getElementById('add-msg');
  msgEl.textContent = '';

  if (!pkg) { alert('Please enter package name'); return; }

  const { data, error } = await supabaseClient.from('apps').insert({
    package_name: pkg,
    note: note || null,
    status: 'unknown',
    created_at: new Date().toISOString()
  }).select().single();

  if (error) {
    alert('Add app error: ' + error.message);
    console.error(error);
    return;
  }

  document.getElementById('pkgInput').value = '';
  document.getElementById('noteInput').value = '';
  msgEl.textContent = 'Added.';
  setTimeout(() => msgEl.textContent = '', 2000);
  renderApps();
});

// 初始加载
renderApps();
</script>
</body>
</html>
